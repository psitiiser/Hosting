<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- The title will be set by JavaScript -->
    <title>Loading Store...</title>
    <style>
        :root {
            --primary-bg: #000000; /* Pure Black */
            --secondary-bg: #0d0d0d; /* Very dark grey for cards/sections */
            --tertiary-bg: #1a1a1a; /* Even lighter for accents/inputs */
            --primary-text: #00ff00; /* Pure Neon Green Text */
            --secondary-text: #00cc00; /* Slightly dimmer Neon Green */
            --accent-color: #00ff00; /* Neon Green Accent */
            --accent-hover: #33ff33; /* Brighter Neon Green on hover */
            --green-accent: #00ff00; /* Ensure prices are Neon Green */
            --border-color: #004400; /* Dark Green Border */
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-logo: 'Orbitron', sans-serif; /* Already present, good for sci-fi */
        }

        /* Astronomy Background Canvas */
        #space-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Ensure it stays behind content */
            pointer-events: none; /* Allow clicks to pass through */
        }

        body {
            font-family: var(--font-main);
            background-color: var(--primary-bg);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow-x: hidden; /* Prevent horizontal scrollbar from canvas or other elements */
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative; /* Ensure content is above the canvas */
            z-index: 1;
        }

        header {
            background-color: var(--secondary-bg);
            padding: 15px 0;
            text-align: center;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--accent-color);
            font-weight: bold;
            letter-spacing: 1px;
        }
        .logo-text {
            font-family: var(--font-logo);
        }

        #products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .product-card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,255,0,0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,255,0,0.2);
        }

        .product-image-container {
            width: 100%;
            max-width: 250px;
            height: 250px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }
        .product-image-slider {
            display: flex;
            height: 100%;
            transition: transform 0.5s ease-in-out;
        }
        .product-image-slider img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            flex-shrink: 0;
        }
        .slider-nav {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
        }
        .slider-dot {
            width: 8px;
            height: 8px;
            background-color: rgba(0,255,0,0.5);
            border-radius: 50%;
            cursor: pointer;
        }
        .slider-dot.active {
            background-color: var(--primary-text);
        }
        .slider-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0,0,0,0.5);
            color: var(--primary-text);
            border: none;
            padding: 8px;
            cursor: pointer;
            z-index: 10;
            border-radius: 50%;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .slider-arrow:hover { opacity: 1; }
        .slider-arrow.prev { left: 5px; }
        .slider-arrow.next { right: 5px; }


        .product-card h3 {
            font-size: 1.4em;
            margin: 10px 0 5px;
            color: var(--primary-text);
        }
        .product-card .description {
            font-size: 0.9em;
            color: var(--secondary-text);
            margin-bottom: 10px;
            min-height: 40px; /* Adjust as needed for your descriptions */
        }
        .product-card .price {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--green-accent);
            margin-bottom: 15px;
        }
        .product-card .sizes, .product-card .quantity-selector {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .product-card .sizes select, .product-card .quantity-selector input {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--tertiary-bg);
            color: var(--primary-text);
            font-size: 0.9em;
        }
        .product-card .quantity-selector input {
            width: 50px;
            text-align: center;
        }
        .product-card .quantity-selector input[type=number]::-webkit-inner-spin-button,
        .product-card .quantity-selector input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .product-card .quantity-selector input[type=number] {
            -moz-appearance: textfield;
        }


        .btn {
            background-color: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            padding: 12px 24px;
            text-transform: uppercase;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .btn:hover {
            background-color: var(--accent-hover);
        }
        .btn-secondary {
            background-color: var(--tertiary-bg);
            color: var(--primary-text);
        }
        .btn-secondary:hover {
            background-color: #006600;
        }

        #cart-icon {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--accent-color);
            color: var(--primary-bg);
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            z-index: 1001;
            font-size: 1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0,255,0,0.4);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        #cart-icon:hover {
            background-color: var(--accent-hover);
            box-shadow: 0 6px 15px rgba(0,255,0,0.6);
        }
        #cart-count {
            position: relative;
            background-color: red;
            color: white;
            border-radius: 50%;
            font-size: 0.7em;
            padding: 2px 5px;
            min-width: 18px;
            text-align: center;
            line-height: 1;
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: var(--secondary-bg);
            margin: 10% auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,255,0,0.3);
        }
        .close-btn {
            color: var(--secondary-text);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover, .close-btn:focus {
            color: var(--primary-text);
            text-decoration: none;
            cursor: pointer;
        }

        #cart-items-list {
            list-style-type: none;
            padding: 0;
        }
        #cart-items-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        #cart-items-list li:last-child {
            border-bottom: none;
        }
        .cart-item-details { flex-grow: 1; }
        .cart-item-name { font-weight: bold; }
        .cart-item-size { font-size: 0.9em; color: var(--secondary-text); }
        .cart-item-quantity button {
            background: var(--tertiary-bg); color: var(--primary-text); border: none;
            padding: 2px 6px; margin: 0 5px; cursor: pointer; border-radius: 3px;
        }
        .cart-item-remove { color: var(--accent-color); cursor: pointer; font-size: 0.9em; }

        #cart-total, #checkout-total-summary {
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
            margin-top: 20px;
            color: var(--primary-text);
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary-text);
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"] {
            width: calc(100% - 22px);
            padding: 10px;
            background-color: var(--tertiary-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--primary-text);
            font-size: 1em;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        #order-confirmation-message { text-align: center; }
        #upi-qr-code {
            display: block;
            margin: 20px auto;
            max-width: 200px;
            border: 2px solid var(--primary-text);
            border-radius: 5px;
            background-color: white; /* Keep QR code on white background for scannability */
            padding: 5px;
        }

        #loader {
            position: fixed;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: var(--primary-text);
            font-size: 1.2em;
        }
        .spinner {
          border: 8px solid var(--tertiary-bg);
          border-top: 8px solid var(--accent-color);
          border-radius: 50%;
          width: 60px;
          height: 60px;
          animation: spin 1s linear infinite;
          margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
</head>
<body>
    <canvas id="space-background"></canvas>

    <div id="loader">
        <div class="spinner"></div>
        <span>Initiating Cosmic Link...</span>
    </div>

    <header>
        <h1 class="logo-text">Loading Store...</h1>
    </header>

    <div class="container">
        <div id="products-grid">
            <!-- Product cards will be injected here -->
        </div>
    </div>

    <div id="cart-icon">
        🛒 Cart <span id="cart-count">0</span>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeCartModal">×</span>
            <h2>Your Cart</h2>
            <div id="cart-empty-message" style="display: none; text-align: center; padding: 20px; color: var(--secondary-text);">Your cart is empty.</div>
            <ul id="cart-items-list"></ul>
            <div id="cart-total">Total: ₹0.00</div>
            <button id="checkoutBtn" class="btn" style="width: 100%; margin-top: 20px;">Proceed to Checkout</button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeCheckoutModal">×</span>
            <h2>Checkout</h2>
            <form id="checkout-form">
                <div class="form-group">
                    <label for="customerName">Full Name:</label>
                    <input type="text" id="customerName" name="customerName" required>
                </div>
                <div class="form-group">
                    <label for="customerEmail">Email Address:</label>
                    <input type="email" id="customerEmail" name="customerEmail" required>
                </div>
                <div class="form-group">
                    <label for="customerPhone">Phone Number (Optional):</label>
                    <input type="tel" id="customerPhone" name="customerPhone">
                </div>
                <div id="checkout-summary">
                    <h3>Order Summary</h3>
                    <ul id="checkout-items-summary-list"></ul>
                    <div id="checkout-total-summary">Total: ₹0.00</div>
                </div>
                <button type="submit" id="placeOrderBtn" class="btn" style="width: 100%; margin-top: 20px;">Place Order & Proceed to Payment</button>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeConfirmationModal">×</span>
            <h2>Order Confirmed!</h2>
            <div id="order-confirmation-message"></div>
            <p style="text-align:center; margin-top: 20px;">
                <a id="upi-payment-link" href="#" target="_blank" class="btn">Pay Now with UPI App</a>
            </p>
            <button id="closeConfirmationAndShopBtn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">Continue Shopping</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION (Client-Side) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzVczj91JqgrffQtUxetNYYFQHDFOpEE0N1lRk40-oF29X4ZV-dvkaLd9GfRWMmws6LQ/exec"; // !!! PASTE YOUR DEPLOYED /exec URL HERE !!!
        const STORE_NAME_CONFIG = ""; // !!! REPLACE THIS WITH YOUR ACTUAL STORE NAME (must match Code.gs) !!!

        // --- DOM ELEMENTS ---
        const productsGrid = document.getElementById('products-grid');
        const cartIcon = document.getElementById('cart-icon');
        const cartCount = document.getElementById('cart-count');
        const cartModal = document.getElementById('cartModal');
        const closeCartModal = document.getElementById('closeCartModal');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotalDisplay = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const cartEmptyMessage = document.getElementById('cart-empty-message');
        const checkoutModal = document.getElementById('checkoutModal');
        const closeCheckoutModal = document.getElementById('closeCheckoutModal');
        const checkoutForm = document.getElementById('checkout-form');
        const checkoutItemsSummaryList = document.getElementById('checkout-items-summary-list');
        const checkoutTotalSummaryDisplay = document.getElementById('checkout-total-summary');
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const confirmationModal = document.getElementById('confirmationModal');
        const closeConfirmationModal = document.getElementById('closeConfirmationModal');
        const orderConfirmationMessage = document.getElementById('order-confirmation-message');
        const upiPaymentLinkElem = document.getElementById('upi-payment-link'); // Renamed for clarity
        const closeConfirmationAndShopBtn = document.getElementById('closeConfirmationAndShopBtn');
        const loader = document.getElementById('loader');
        const headerLogoText = document.querySelector('header h1.logo-text');

        // --- APP STATE ---
        let productsData = [];
        let cart = {}; // Format: { "P001_M": {id, name, price, quantity, size, imageUrl}, ... }

        // --- BACKGROUND ANIMATION ---
        // (Your existing star animation code is fine, no changes needed here)
        const canvas = document.getElementById('space-background');
        const ctx = canvas.getContext('2d');
        let stars = [];
        const numStars = 300;
        const maxStarRadius = 1.5;
        const starColor = 'rgba(255, 255, 255, ';

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initializeStars();
        }
        class Star { /* ... (Keep your Star class definition) ... */
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.radius = Math.random() * maxStarRadius;
                this.opacity = Math.random();
                this.twinkleSpeed = Math.random() * 0.005 + 0.001;
                this.twinkleDirection = Math.random() < 0.5 ? 1 : -1;
                this.moveSpeedY = Math.random() * 0.5 + 0.1;
                this.moveSpeedX = (Math.random() - 0.5) * 0.2;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
                ctx.fillStyle = starColor + this.opacity + ')';
                ctx.fill();
            }
            update() {
                this.opacity += this.twinkleSpeed * this.twinkleDirection;
                if (this.opacity > 1 || this.opacity < 0) {
                    this.twinkleDirection *= -1;
                    this.opacity = Math.max(0, Math.min(1, this.opacity));
                }
                this.y += this.moveSpeedY;
                this.x += this.moveSpeedX;
                if (this.y - this.radius > canvas.height) {
                    this.y = -this.radius;
                    this.x = Math.random() * canvas.width;
                }
                if (this.x - this.radius > canvas.width) {
                    this.x = -this.radius;
                    this.y = Math.random() * canvas.height;
                } else if (this.x + this.radius < 0) {
                    this.x = canvas.width + this.radius;
                    this.y = Math.random() * canvas.height;
                }
            }
        }
        function initializeStars() {
            stars = [];
            for (let i = 0; i < numStars; i++) {
                stars.push(new Star());
            }
        }
        function animateStars() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach(star => {
                star.update();
                star.draw();
            });
            requestAnimationFrame(animateStars);
        }
        window.addEventListener('resize', resizeCanvas);


        // --- IMAGE SLIDER ---
        // (Your existing initializeSlider function is fine, no changes needed)
        function initializeSlider(sliderContainer) { /* ... (Keep your initializeSlider definition) ... */
            const slider = sliderContainer.querySelector('.product-image-slider');
            const images = slider.querySelectorAll('img');
            if (images.length <= 1) {
                sliderContainer.querySelectorAll('.slider-nav, .slider-arrow').forEach(el => el.style.display = 'none');
                return;
            }
            let currentIndex = 0;
            const dotsContainer = sliderContainer.querySelector('.slider-nav');
            dotsContainer.innerHTML = ''; // Clear previous dots if any
            images.forEach((img, index) => {
                const dot = document.createElement('span');
                dot.classList.add('slider-dot');
                if (index === 0) dot.classList.add('active');
                dot.addEventListener('click', () => goToSlide(index));
                dotsContainer.appendChild(dot);
            });
            const dots = dotsContainer.querySelectorAll('.slider-dot');
            function goToSlide(index) {
                slider.style.transform = `translateX(-${index * 100}%)`;
                if (dots[currentIndex]) dots[currentIndex].classList.remove('active'); // Check if current dot exists
                if (dots[index]) dots[index].classList.add('active'); // Check if new dot exists
                currentIndex = index;
            }
            const nextArrow = sliderContainer.querySelector('.slider-arrow.next');
            const prevArrow = sliderContainer.querySelector('.slider-arrow.prev');
            if(nextArrow) nextArrow.addEventListener('click', () => goToSlide((currentIndex + 1) % images.length));
            if(prevArrow) prevArrow.addEventListener('click', () => goToSlide((currentIndex - 1 + images.length) % images.length));
        }


        // --- PRODUCT DISPLAY ---
        // (Your existing renderProducts function is mostly fine, minor adjustments for error checking)
        function renderProducts(productsResponse) {
            console.log("Received products for rendering:", productsResponse);
            if (productsResponse.error) {
                productsGrid.innerHTML = `<p style="color:red; text-align:center;">Error: ${productsResponse.error}</p>`;
                loader.style.display = 'none';
                return;
            }
            productsData = productsResponse; // Store globally (assuming productsResponse is the array itself)
            productsGrid.innerHTML = '';

            if (!productsData || productsData.length === 0) {
                 productsGrid.innerHTML = `<p style="text-align:center;">No products available at the moment. Check back soon!</p>`;
                 loader.style.display = 'none';
                 return;
            }

            productsData.forEach(product => {
                const card = document.createElement('div');
                card.classList.add('product-card');
                card.dataset.productId = product.id;

                let imagesHtml = product.imageUrls && product.imageUrls.length > 0
                    ? product.imageUrls.map(url => `<img src="${url}" alt="${product.name}">`).join('')
                    : `<img src="https://via.placeholder.com/250x250.png?text=No+Image" alt="${product.name}">`;

                let sizesDropdown = '';
                if (product.sizes && product.sizes.length > 0 && !(product.sizes.length === 1 && product.sizes[0].toUpperCase() === 'N/A')) {
                    sizesDropdown = `<div class="sizes">
                        <label for="size-${product.id}" style="margin-right: 5px;">Size:</label>
                        <select id="size-${product.id}" class="product-size-select">
                            ${product.sizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                        </select>
                    </div>`;
                } else {
                     sizesDropdown = `<input type="hidden" class="product-size-select" value="N/A">`;
                }

                card.innerHTML = `
                    <div class="product-image-container">
                        <div class="product-image-slider">${imagesHtml}</div>
                        <button class="slider-arrow prev">❮</button>
                        <button class="slider-arrow next">❯</button>
                        <div class="slider-nav"></div>
                    </div>
                    <h3>${product.name}</h3>
                    <p class="description">${product.description || ''}</p>
                    <p class="price">₹${parseFloat(product.price).toFixed(2)}</p>
                    ${sizesDropdown}
                    <div class="quantity-selector">
                        <label for="quantity-${product.id}" style="margin-right: 5px;">Qty:</label>
                        <input type="number" id="quantity-${product.id}" class="product-quantity-input" value="1" min="1">
                    </div>
                    <button class="btn add-to-cart-btn">Add to Cart</button>
                `;
                productsGrid.appendChild(card);
                initializeSlider(card.querySelector('.product-image-container'));
            });
            loader.style.display = 'none';
        }

        // --- CART LOGIC ---
        // (Your existing cart functions: getCartItemId, addToCart, showToast, updateCartQuantity, removeFromCart, updateCartDisplay, updateCheckoutSummary are fine, no changes needed)
        function getCartItemId(productId, size) { /* ... (Keep your definition) ... */ return `${productId}_${size}`; }
        function addToCart(productId) { /* ... (Keep your definition) ... */
            console.log("Attempting to add to cart. Product ID:", productId);
            console.log("Current productsData:", productsData);

            const product = productsData.find(p => p.id === productId);
            if (!product) {
                console.error("Product not found in productsData with ID:", productId);
                alert("Error: Product details not found. Please try again.");
                return;
            }
            console.log("Found product:", product);

            const productCardElement = document.querySelector(`.product-card[data-product-id="${productId}"]`);
            if (!productCardElement) {
                console.error("Could not find product card element for ID:", productId);
                alert("Error: UI element not found. Please refresh.");
                return;
            }

            const sizeSelect = productCardElement.querySelector(`.product-size-select`);
            const selectedSize = sizeSelect ? sizeSelect.value : 'N/A';
            console.log("Selected size:", selectedSize);

            const quantityInput = productCardElement.querySelector(`.product-quantity-input`);
            const quantityToAdd = quantityInput ? parseInt(quantityInput.value) : 1;
            console.log("Quantity to add:", quantityToAdd);

            if (isNaN(quantityToAdd) || quantityToAdd < 1) {
                alert("Please enter a valid quantity (1 or more).");
                if(quantityInput) quantityInput.value = 1; // Reset invalid input
                return;
            }

            const cartItemId = getCartItemId(product.id, selectedSize);
            console.log("Cart Item ID:", cartItemId);

            if (cart[cartItemId]) {
                cart[cartItemId].quantity += quantityToAdd;
                console.log("Existing item, updated quantity:", cart[cartItemId].quantity);
            } else {
                cart[cartItemId] = {
                    id: product.id,
                    name: product.name,
                    price: parseFloat(product.price),
                    quantity: quantityToAdd,
                    size: selectedSize,
                    imageUrl: (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : 'https://via.placeholder.com/50'
                };
                console.log("New item added to cart:", cart[cartItemId]);
            }

            updateCartDisplay();
            showToast(`${quantityToAdd} x ${product.name} (${selectedSize}) added to cart!`);
            if(quantityInput) quantityInput.value = 1; // Reset quantity input on card
        }
        function showToast(message) { /* ... (Keep your definition) ... */
            const toast = document.createElement('div');
            toast.textContent = message;
            Object.assign(toast.style, {
                position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',
                backgroundColor: 'var(--accent-color)', color: 'var(--primary-bg)', padding: '10px 20px',
                borderRadius: '5px', zIndex: '2000', opacity: '0', transition: 'opacity 0.3s ease'
            });
            document.body.appendChild(toast);
            setTimeout(() => toast.style.opacity = '1', 10);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2700);
        }
        function updateCartQuantity(cartItemId, change) { /* ... (Keep your definition) ... */
            console.log("Updating quantity for cartItemId:", cartItemId, "Change:", change);
            if (cart[cartItemId]) {
                cart[cartItemId].quantity += change;
                if (cart[cartItemId].quantity <= 0) {
                    delete cart[cartItemId];
                    console.log("Item removed due to quantity <= 0");
                } else {
                    console.log("New quantity:", cart[cartItemId].quantity);
                }
            }
            updateCartDisplay();
        }
        function removeFromCart(cartItemId) { /* ... (Keep your definition) ... */
            console.log("Removing cartItemId:", cartItemId);
            if (cart[cartItemId]) {
                delete cart[cartItemId];
            }
            updateCartDisplay();
        }
        function updateCartDisplay() { /* ... (Keep your definition) ... */
            console.log("Updating cart display. Current cart:", cart);
            cartItemsList.innerHTML = '';
            let total = 0;
            let itemCount = 0;
            const cartItemIds = Object.keys(cart);

            if (cartItemIds.length === 0) {
                cartEmptyMessage.style.display = 'block';
                checkoutBtn.style.display = 'none';
            } else {
                cartEmptyMessage.style.display = 'none';
                checkoutBtn.style.display = 'block';
                cartItemIds.forEach(cartItemId => {
                    const item = cart[cartItemId];
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <img src="${item.imageUrl}" alt="${item.name}" style="width:50px; height:50px; object-fit:cover; margin-right:10px; border-radius:4px;">
                        <div class="cart-item-details">
                            <span class="cart-item-name">${item.name}</span><br>
                            <span class="cart-item-size">Size: ${item.size}</span><br>
                            <span>₹${item.price.toFixed(2)}</span>
                        </div>
                        <div class="cart-item-quantity">
                            <button onclick="updateCartQuantity('${cartItemId}', -1)" title="Decrease quantity">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateCartQuantity('${cartItemId}', 1)" title="Increase quantity">+</button>
                        </div>
                        <span>₹${(item.price * item.quantity).toFixed(2)}</span>
                        <span class="cart-item-remove" onclick="removeFromCart('${cartItemId}')" style="margin-left: 15px; cursor:pointer;" title="Remove item"> 🗑️</span>
                    `;
                    cartItemsList.appendChild(li);
                    total += item.price * item.quantity;
                    itemCount += item.quantity;
                });
            }
            cartTotalDisplay.textContent = `Total: ₹${total.toFixed(2)}`;
            cartCount.textContent = itemCount;
            if (checkoutModal.style.display === 'block') {
                updateCheckoutSummary(Object.values(cart), total);
            }
            console.log("Cart display updated. Total items:", itemCount, "Total price:", total.toFixed(2));
        }
        function updateCheckoutSummary(cartItemsArray, total) { /* ... (Keep your definition) ... */
            checkoutItemsSummaryList.innerHTML = '';
            if(cartItemsArray.length === 0) {
                 checkoutItemsSummaryList.innerHTML = '<li>Your cart is empty.</li>';
            } else {
                cartItemsArray.forEach(item => {
                    const li = document.createElement('li');
                    li.style.fontSize = "0.9em";
                    li.style.padding = "5px 0";
                    li.textContent = `${item.name} (${item.size}) x ${item.quantity} - ₹${(item.price * item.quantity).toFixed(2)}`;
                    checkoutItemsSummaryList.appendChild(li);
                });
            }
            checkoutTotalSummaryDisplay.textContent = `Total: ₹${total.toFixed(2)}`;
        }


        // --- MODAL HANDLING ---
        // (Your existing modal handling is fine, no changes needed)
        cartIcon.onclick = () => { updateCartDisplay(); cartModal.style.display = 'block'; }
        closeCartModal.onclick = () => { cartModal.style.display = 'none'; }
        checkoutBtn.onclick = () => {
            cartModal.style.display = 'none';
            const currentCartItems = Object.values(cart);
            const currentTotal = currentCartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            updateCheckoutSummary(currentCartItems, currentTotal);
            checkoutModal.style.display = 'block';
        }
        closeCheckoutModal.onclick = () => { checkoutModal.style.display = 'none'; }
        closeConfirmationModal.onclick = () => { confirmationModal.style.display = 'none'; }
        closeConfirmationAndShopBtn.onclick = () => { confirmationModal.style.display = 'none'; }
        window.onclick = (event) => {
            if (event.target == cartModal) cartModal.style.display = 'none';
            if (event.target == checkoutModal) checkoutModal.style.display = 'none';
            if (event.target == confirmationModal) confirmationModal.style.display = 'none';
        }


        // --- CHECKOUT AND ORDER SUBMISSION (Modified for fetch API) ---
        checkoutForm.addEventListener('submit', (e) => {
            e.preventDefault();
            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = 'Processing...';
            loader.style.display = 'flex';

            const orderPayload = {
                customerName: document.getElementById('customerName').value,
                customerEmail: document.getElementById('customerEmail').value,
                customerPhone: document.getElementById('customerPhone').value,
                cartItems: Object.values(cart),
                totalPrice: Object.values(cart).reduce((sum, item) => sum + (item.price * item.quantity), 0)
            };
            console.log("Submitting order via fetch:", orderPayload);

            fetch(SCRIPT_URL, {
                method: 'POST',
                // mode: 'no-cors', // Usually not needed for Apps Script if doPost returns ContentService
                headers: {
                    // 'Content-Type': 'application/json', // Apps Script's e.postData.contents is usually plain text
                    'Content-Type': 'text/plain', // More robust for Apps Script `e.postData.contents`
                },
                body: JSON.stringify({ action: "processOrder", payload: orderPayload })
            })
            .then(response => {
                if (!response.ok) {
                    // If server responds with an error status (4xx, 5xx)
                    return response.text().then(text => { throw new Error(`Server error: ${response.status} ${response.statusText} - ${text}`) });
                }
                return response.json();
            })
            .then(data => { // This is the 'response' object from your Apps Script 'processOrder'
                handleOrderSuccess(data);
            })
            .catch(error => {
                handleOrderFailure(error);
            });
        });

        function handleOrderSuccess(response) { // response is the JSON from Apps Script
            console.log("Order success response received from fetch:", response);

            loader.style.display = 'none';
            placeOrderBtn.disabled = false;
            placeOrderBtn.textContent = 'Place Order & Proceed to Payment';

            if (response.success) {
                checkoutModal.style.display = 'none';
                cart = {}; // Clear cart
                updateCartDisplay();
                checkoutForm.reset();

                // Data from Apps Script response
                const upiId = response.upiId;
                const customerName = response.customerName || 'Customer';
                const orderId = response.orderId;
                const totalPrice = parseFloat(response.totalPrice);
                const responseStoreName = response.storeName || STORE_NAME_CONFIG; // Use response's store name

                if (!upiId || isNaN(totalPrice) || !orderId) {
                    console.error("Missing critical data for QR code/payment link generation:", { upiId, totalPrice, orderId });
                    orderConfirmationMessage.innerHTML = `
                        <p>Thank you, ${customerName}! Your order #${orderId} has been placed.</p>
                        <p>Total Amount: <strong>₹${totalPrice ? totalPrice.toFixed(2) : 'N/A'}</strong></p>
                        <p>Payment details are incomplete. Please check your email for payment instructions.</p>
                        <p>A confirmation email has been sent to your email address.</p>
                        <p><strong>Important:</strong> Please reply to the confirmation email with a payment screenshot or transaction ID for faster processing.</p>
                    `;
                    alert("Order placed, but QR code could not be generated due to missing payment details. Please check your email for instructions.");
                    confirmationModal.style.display = 'block';
                    return;
                }

                const upiPaymentData = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(responseStoreName)}&am=${totalPrice.toFixed(2)}&cu=INR&tn=Order%20${orderId}`;
                const qrCodeSrc = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiPaymentData)}`;

                orderConfirmationMessage.innerHTML = `
                    <p>Thank you, ${customerName}! Your order #${orderId} has been placed.</p>
                    <p>Total Amount: <strong>₹${totalPrice.toFixed(2)}</strong></p>
                    <p>Please complete your payment using the UPI ID: <strong>${upiId}</strong></p>
                    <p><strong>And send the screenshot of the payment as the reply to the confirmation mail we send you</strong></p>
                    <p>You can also use the button below to pay with your UPI app, or scan this QR code:</p>
                    <img id="upi-qr-code" src="${qrCodeSrc}" alt="UPI QR Code">
                    <p>A confirmation email with payment instructions has been sent to your email address.</p>
                    <p><strong>Important:</strong> Please reply to the confirmation email with a payment screenshot or transaction ID for faster processing.</p>
                `;

                if (upiPaymentLinkElem) {
                    upiPaymentLinkElem.href = upiPaymentData;
                } else {
                    console.warn("upiPaymentLinkElem element not found. UPI payment button might not work.");
                }

                confirmationModal.style.display = 'block';
                 // Ensure QR code img is in DOM before trying to log its src
                setTimeout(() => {
                    const qrImg = document.getElementById('upi-qr-code');
                    if (qrImg) console.log("QR Code Image src:", qrImg.src);
                    else console.error("QR Code image element not found after setting innerHTML.");
                }, 0);


            } else {
                alert(`Order failed: ${response.message || 'Unknown error. Please try again.'}`);
            }
        }

        function handleOrderFailure(error) {
            loader.style.display = 'none';
            placeOrderBtn.disabled = false;
            placeOrderBtn.textContent = 'Place Order & Proceed to Payment';
            console.error("Order submission failed (fetch):", error);
            alert(`Error placing order: ${error.message || 'An unknown error occurred'}. Please check console for details and try again.`);
        }

        // --- INITIAL LOAD (Modified for fetch API) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set Store Name in UI
            document.title = STORE_NAME_CONFIG;
            if (headerLogoText) {
                headerLogoText.textContent = STORE_NAME_CONFIG;
            } else {
                console.warn("Header logo text element not found.");
            }

            if (!SCRIPT_URL || SCRIPT_URL === "YOUR_APPS_SCRIPT_WEB_APP_EXEC_URL_HERE") {
                alert("CRITICAL ERROR: SCRIPT_URL is not configured in the HTML. Please edit index.html and set the SCRIPT_URL variable.");
                loader.style.display = 'none';
                productsGrid.innerHTML = `<p style="color:red; text-align:center;">Configuration error: API URL not set.</p>`;
                return;
            }


            console.log("DOM fully loaded and parsed. Fetching products via fetch API...");
            loader.style.display = 'flex';

            resizeCanvas();
            initializeStars();
            animateStars();

            fetch(`${SCRIPT_URL}?action=getProducts`)
                .then(response => {
                    if (!response.ok) {
                        // If server responds with an error status (4xx, 5xx)
                        return response.text().then(text => { throw new Error(`Server error: ${response.status} ${response.statusText} - ${text}`) });
                    }
                    return response.json();
                })
                .then(data => { // data is the response from Apps Script's getProducts
                    renderProducts(data);
                })
                .catch(err => {
                    console.error("Failed to load products from server (fetch):", err);
                    productsGrid.innerHTML = `<p style="color:red; text-align:center;">Error loading products. Please try refreshing the page. Check console for details.</p>`;
                    loader.style.display = 'none';
                });

            productsGrid.addEventListener('click', event => {
                if (event.target.classList.contains('add-to-cart-btn')) {
                    const card = event.target.closest('.product-card');
                    if (card && card.dataset.productId) {
                         const productId = card.dataset.productId;
                         console.log("Add to Cart button clicked for productId:", productId);
                         addToCart(productId);
                    } else {
                        console.error("Could not find product ID on clicked card.");
                    }
                }
            });
        });
    </script>
</body>
</html>
